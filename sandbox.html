<!doctype html>
<html>
    <head>
        <script type="text/javascript">
const audioContext = new AudioContext()

function audioWorkletCode() {
    console.log("AudioWorklet: start")

    const BLOCK_SIZE = 1024

    class DoubleBufferProcessor extends AudioWorkletProcessor {
        constructor(options) {
            console.log("AudioWorklet: constructor")
            super()
            this.currentBuffer = new Float32Array(BLOCK_SIZE)
            this.nextBuffer = new Float32Array(BLOCK_SIZE)
            this.index = 0

            this.port.onmessage = (e) => {
                this.nextBuffer = e.data
                this.nextBufferReady = true
            }

            this.swapBuffers()
        }

        swapBuffers() {
            [this.currentBuffer, this.nextBuffer] = [this.nextBuffer, this.currentBuffer]
            this.index = 0
            this.nextBufferReady = false
            // Send next buffer for the Web Worker to fill.
            this.port.postMessage(this.nextBuffer, [this.nextBuffer.buffer])
        }

        process(inputs, outputs, parameters) {
            const output = outputs[0][0]
            if (this.index >= BLOCK_SIZE) {
                // Currently in underrun.
                if (this.index === BLOCK_SIZE) {
                    // Only print this once per underrun-streak.
                    console.log("Underrun!")
                }
                output.fill(0)
            } else {
                output.set(this.currentBuffer.subarray(this.index, this.index + output.length))
            }
            // NOTE: This assumes BLOCK_SIZE is a multiple of output.length (128).
            this.index += output.length
            if (this.index >= BLOCK_SIZE && this.nextBufferReady) {
                this.swapBuffers()
            }
            return true
        }
    }

    registerProcessor("doublebuffer", DoubleBufferProcessor)
}

function getBody(fn) {
    const s = fn.toString()
    return s.slice(s.indexOf("{") + 1, s.lastIndexOf("}"))
}

const webWorker = new Worker("worker.js")

function resumeContextOnInteraction() {
    // from https://github.com/captbaritone/winamp2-js/blob/a5a76f554c369637431fe809d16f3f7e06a21969/js/media/index.js#L8-L27
    if (audioContext.state === "suspended") {
        const resume = async () => {
            await audioContext.resume()
            if (audioContext.state === "running") {
                document.body.removeEventListener("touchend", resume, false)
                document.body.removeEventListener("click", resume, false)
                document.body.removeEventListener("keydown", resume, false)
            }
            setupAudio()
        }
        document.body.addEventListener("touchend", resume, false)
        document.body.addEventListener("click", resume, false)
        document.body.addEventListener("keydown", resume, false)
    } else {
        setupAudio()
    }
}

let audioWorklet

async function setupAudio() {
    await audioContext.resume()
    console.log("Sample rate:", audioContext.sampleRate)
    await audioContext.audioWorklet.addModule(window.URL.createObjectURL(
        new Blob([getBody(audioWorkletCode)], { type: "application/javascript" })
    ))
    audioWorklet = new AudioWorkletNode(audioContext, "doublebuffer", {
        numberOfInputs: 0,
        numberOfOutputs: 1,
        outputChannelCount: [1],
    })
}

function play(name) {
    // Send sample rate and Audio Worklet's port to the Web Worker, which will generate the samples as needed.
    webWorker.postMessage({ name, sampleRate: audioContext.sampleRate, port: audioWorklet.port }, [audioWorklet.port])
    audioWorklet.connect(audioContext.destination)
}
        </script>
    </head>
    <body>
        <form>
            <input type="text" placeholder="Composition name" />
        </form>
        <script type="text/javascript">
resumeContextOnInteraction()
const formEl = document.querySelector("form")
const nameEl = formEl.querySelector("input")
formEl.onsubmit = (event) => {
    event.preventDefault()
    play(nameEl.value)
}
        </script>
    </body>
</html>
